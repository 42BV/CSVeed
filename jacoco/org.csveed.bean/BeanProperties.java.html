<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BeanProperties.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CSVeed</a> &gt; <a href="index.source.html" class="el_package">org.csveed.bean</a> &gt; <span class="el_source">BeanProperties.java</span></div><h1>BeanProperties.java</h1><pre class="source lang-java linenums">/*
 * CSVeed (https://github.com/42BV/CSVeed)
 *
 * Copyright 2013-2023 CSVeed.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of The Apache Software License,
 * Version 2.0 which accompanies this distribution, and is available at
 * https://www.apache.org/licenses/LICENSE-2.0.txt
 */
package org.csveed.bean;

import java.beans.BeanInfo;
import java.beans.IntrospectionException;
import java.beans.Introspector;
import java.beans.PropertyDescriptor;
import java.lang.reflect.Field;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.csveed.bean.conversion.Converter;
import org.csveed.bean.conversion.CustomNumberConverter;
import org.csveed.bean.conversion.DateConverter;
import org.csveed.bean.conversion.EnumConverter;
import org.csveed.common.Column;
import org.csveed.report.CsvException;
import org.csveed.report.GeneralError;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * The Class BeanProperties.
 */
public class BeanProperties implements Iterable&lt;BeanProperty&gt; {

    /** The Constant LOG. */
<span class="fc" id="L43">    private static final Logger LOG = LoggerFactory.getLogger(BeanProperties.class);</span>

    /** The properties. */
<span class="fc" id="L46">    private List&lt;BeanProperty&gt; properties = new ArrayList&lt;&gt;();</span>

    /** The index to property. */
<span class="fc" id="L49">    private Map&lt;Column, BeanProperty&gt; indexToProperty = new TreeMap&lt;&gt;();</span>

    /** The name to property. */
<span class="fc" id="L52">    private Map&lt;Column, BeanProperty&gt; nameToProperty = new TreeMap&lt;&gt;();</span>

    /** The bean class. */
    private Class beanClass;

    /** The header value property. */
    private BeanProperty headerValueProperty;

    /** The header name property. */
    private BeanProperty headerNameProperty;

    /**
     * Instantiates a new bean properties.
     *
     * @param beanClass
     *            the bean class
     */
<span class="fc" id="L69">    public BeanProperties(Class beanClass) {</span>
<span class="fc" id="L70">        this.beanClass = beanClass;</span>
<span class="fc" id="L71">        parseBean(beanClass);</span>
<span class="fc" id="L72">    }</span>

    /**
     * Parses the bean.
     *
     * @param beanClass
     *            the bean class
     */
    private void parseBean(Class beanClass) {
        final BeanInfo beanInfo;
        try {
<span class="fc" id="L83">            beanInfo = Introspector.getBeanInfo(beanClass);</span>
<span class="nc" id="L84">        } catch (IntrospectionException err) {</span>
<span class="nc" id="L85">            throw new RuntimeException(err);</span>
<span class="fc" id="L86">        }</span>

<span class="fc" id="L88">        PropertyDescriptor[] propertyDescriptors = beanInfo.getPropertyDescriptors();</span>

        // Note that we use getDeclaredFields here instead of the PropertyDescriptor order. The order we now
        // use is guaranteed to be the declaration order from JDK 6+, which is exactly what we need.
<span class="fc bfc" id="L92" title="All 2 branches covered.">        for (Field field : beanClass.getDeclaredFields()) {</span>
<span class="fc" id="L93">            PropertyDescriptor propertyDescriptor = getPropertyDescriptor(propertyDescriptors, field);</span>
<span class="pc bpc" id="L94" title="1 of 4 branches missed.">            if (propertyDescriptor == null || propertyDescriptor.getWriteMethod() == null) {</span>
<span class="fc" id="L95">                LOG.info(&quot;Skipping {}.{}&quot;, beanClass.getName(), field.getName());</span>
<span class="fc" id="L96">                continue;</span>
            }
<span class="fc" id="L98">            addProperty(propertyDescriptor, field);</span>
        }

<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (beanClass.getSuperclass() != null) {</span>
<span class="fc" id="L102">            parseBean(beanClass.getSuperclass());</span>
        }
<span class="fc" id="L104">    }</span>

    /**
     * Adds the property.
     *
     * @param propertyDescriptor
     *            the property descriptor
     * @param field
     *            the field
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void addProperty(PropertyDescriptor propertyDescriptor, Field field) {
<span class="fc" id="L116">        BeanProperty beanProperty = new BeanProperty();</span>
<span class="fc" id="L117">        beanProperty.setPropertyDescriptor(propertyDescriptor);</span>
<span class="fc" id="L118">        beanProperty.setField(field);</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (Enum.class.isAssignableFrom(propertyDescriptor.getPropertyType())) {</span>
<span class="fc" id="L120">            beanProperty.setConverter(new EnumConverter(propertyDescriptor.getPropertyType()));</span>
        }
<span class="fc" id="L122">        this.properties.add(beanProperty);</span>
<span class="fc" id="L123">    }</span>

    /**
     * Gets the property descriptor.
     *
     * @param propertyDescriptors
     *            the property descriptors
     * @param field
     *            the field
     *
     * @return the property descriptor
     */
    private PropertyDescriptor getPropertyDescriptor(PropertyDescriptor[] propertyDescriptors, Field field) {
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (PropertyDescriptor propertyDescriptor : propertyDescriptors) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            if (field.getName().equals(propertyDescriptor.getName())) {</span>
<span class="fc" id="L138">                return propertyDescriptor;</span>
            }
        }
<span class="fc" id="L141">        return null;</span>
    }

    /**
     * Sets the required.
     *
     * @param propertyName
     *            the property name
     * @param required
     *            the required
     */
    public void setRequired(String propertyName, boolean required) {
<span class="fc" id="L153">        get(propertyName).setRequired(required);</span>
<span class="fc" id="L154">    }</span>

    /**
     * Sets the date.
     *
     * @param propertyName
     *            the property name
     * @param formatText
     *            the format text
     */
    public void setDate(String propertyName, String formatText) {
<span class="fc" id="L165">        setConverter(propertyName, new DateConverter(formatText, true));</span>
<span class="fc" id="L166">    }</span>

    /**
     * Sets the localized number.
     *
     * @param propertyName
     *            the property name
     * @param locale
     *            the locale
     */
    public void setLocalizedNumber(String propertyName, Locale locale) {
<span class="fc" id="L177">        Class&lt;? extends Number&gt; numberClass = get(propertyName).getNumberClass();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">        if (numberClass == null) {</span>
<span class="fc" id="L179">            throw new CsvException(new GeneralError(</span>
<span class="fc" id="L180">                    &quot;Property &quot; + beanClass.getName() + &quot;.&quot; + propertyName + &quot; is not a java.lang.Number&quot;));</span>
        }
<span class="fc" id="L182">        CustomNumberConverter converter = new CustomNumberConverter(numberClass, NumberFormat.getNumberInstance(locale),</span>
                true);
<span class="fc" id="L184">        setConverter(propertyName, converter);</span>
<span class="fc" id="L185">    }</span>

    /**
     * Sets the converter.
     *
     * @param propertyName
     *            the property name
     * @param converter
     *            the converter
     */
    public void setConverter(String propertyName, Converter converter) {
<span class="fc" id="L196">        get(propertyName).setConverter(converter);</span>
<span class="fc" id="L197">    }</span>

    /**
     * Removes the from column index.
     *
     * @param property
     *            the property
     */
    protected void removeFromColumnIndex(BeanProperty property) {
<span class="fc bfc" id="L206" title="All 2 branches covered.">        while (indexToProperty.values().remove(property)) {</span>

        }
<span class="fc" id="L209">    }</span>

    /**
     * Removes the from column name.
     *
     * @param property
     *            the property
     */
    protected void removeFromColumnName(BeanProperty property) {
<span class="fc bfc" id="L218" title="All 2 branches covered.">        while (nameToProperty.values().remove(property)) {</span>

        }
<span class="fc" id="L221">    }</span>

    /**
     * Ignore property.
     *
     * @param propertyName
     *            the property name
     */
    public void ignoreProperty(String propertyName) {
<span class="fc" id="L230">        BeanProperty property = get(propertyName);</span>
<span class="fc" id="L231">        properties.remove(property);</span>
<span class="fc" id="L232">        removeFromColumnIndex(property);</span>
<span class="fc" id="L233">        removeFromColumnName(property);</span>
<span class="fc" id="L234">    }</span>

    /**
     * Sets the header value property.
     *
     * @param propertyName
     *            the new header value property
     */
    public void setHeaderValueProperty(String propertyName) {
<span class="fc" id="L243">        this.headerValueProperty = get(propertyName);</span>
<span class="fc" id="L244">        this.headerValueProperty.setDynamicColumnProperty(true);</span>
<span class="fc" id="L245">    }</span>

    /**
     * Sets the header name property.
     *
     * @param propertyName
     *            the new header name property
     */
    public void setHeaderNameProperty(String propertyName) {
<span class="fc" id="L254">        this.headerNameProperty = get(propertyName);</span>
<span class="fc" id="L255">        this.headerNameProperty.setDynamicColumnProperty(true);</span>
<span class="fc" id="L256">    }</span>

    /**
     * Gets the header value property.
     *
     * @return the header value property
     */
    public BeanProperty getHeaderValueProperty() {
<span class="fc" id="L264">        return this.headerValueProperty;</span>
    }

    /**
     * Gets the header name property.
     *
     * @return the header name property
     */
    public BeanProperty getHeaderNameProperty() {
<span class="fc" id="L273">        return this.headerNameProperty;</span>
    }

    /**
     * Map index to property.
     *
     * @param columnIndex
     *            the column index
     * @param propertyName
     *            the property name
     */
    public void mapIndexToProperty(int columnIndex, String propertyName) {
<span class="fc" id="L285">        BeanProperty property = get(propertyName);</span>
<span class="fc" id="L286">        removeFromColumnIndex(property);</span>
<span class="fc" id="L287">        property.setColumnIndex(columnIndex);</span>
<span class="fc" id="L288">        indexToProperty.put(new Column(columnIndex), property);</span>
<span class="fc" id="L289">    }</span>

    /**
     * Map name to property.
     *
     * @param columnName
     *            the column name
     * @param propertyName
     *            the property name
     */
    public void mapNameToProperty(String columnName, String propertyName) {
<span class="fc" id="L300">        BeanProperty property = get(propertyName);</span>
<span class="fc" id="L301">        removeFromColumnName(property);</span>
<span class="fc" id="L302">        property.setColumnName(columnName);</span>
<span class="fc" id="L303">        nameToProperty.put(new Column(columnName.toLowerCase(Locale.getDefault())), property);</span>
<span class="fc" id="L304">    }</span>

    /**
     * Gets the.
     *
     * @param propertyName
     *            the property name
     *
     * @return the bean property
     */
    protected BeanProperty get(String propertyName) {
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        for (BeanProperty beanProperty : properties) {</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">            if (beanProperty.getPropertyName().equals(propertyName)) {</span>
<span class="fc" id="L317">                return beanProperty;</span>
            }
<span class="fc" id="L319">        }</span>
<span class="nc" id="L320">        throw new CsvException(</span>
<span class="nc" id="L321">                new GeneralError(&quot;Property does not exist: &quot; + beanClass.getName() + &quot;.&quot; + propertyName));</span>
    }

    /**
     * From index.
     *
     * @param column
     *            the column
     *
     * @return the bean property
     */
    public BeanProperty fromIndex(Column column) {
<span class="fc" id="L333">        return indexToProperty.get(column);</span>
    }

    /**
     * From name.
     *
     * @param column
     *            the column
     *
     * @return the bean property
     */
    public BeanProperty fromName(Column column) {
<span class="fc" id="L345">        return nameToProperty.get(column);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public Iterator&lt;BeanProperty&gt; iterator() {
<span class="fc" id="L351">        return ((List&lt;BeanProperty&gt;) ((ArrayList&lt;BeanProperty&gt;) this.properties).clone()).iterator();</span>
    }

    /**
     * Column index keys.
     *
     * @return the sets the
     */
    public Set&lt;Column&gt; columnIndexKeys() {
<span class="fc" id="L360">        return this.indexToProperty.keySet();</span>
    }

    /**
     * Column name keys.
     *
     * @return the sets the
     */
    public Set&lt;Column&gt; columnNameKeys() {
<span class="fc" id="L369">        return this.nameToProperty.keySet();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>