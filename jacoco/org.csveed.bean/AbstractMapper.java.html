<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CSVeed</a> &gt; <a href="index.source.html" class="el_package">org.csveed.bean</a> &gt; <span class="el_source">AbstractMapper.java</span></div><h1>AbstractMapper.java</h1><pre class="source lang-java linenums">/*
 * CSVeed (https://github.com/42BV/CSVeed)
 *
 * Copyright 2013-2023 CSVeed.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of The Apache Software License,
 * Version 2.0 which accompanies this distribution, and is available at
 * https://www.apache.org/licenses/LICENSE-2.0.txt
 */
package org.csveed.bean;

import java.util.Set;

import org.csveed.api.Header;
import org.csveed.api.Row;
import org.csveed.bean.conversion.BeanWrapper;
import org.csveed.bean.conversion.ConversionException;
import org.csveed.bean.conversion.DefaultConverters;
import org.csveed.common.Column;
import org.csveed.report.CsvException;
import org.csveed.report.RowError;

/**
 * The Class AbstractMapper.
 *
 * @param &lt;T&gt;
 *            the generic type
 */
<span class="fc" id="L30">public abstract class AbstractMapper&lt;T&gt; {</span>

    /** The bean instructions. */
    protected BeanInstructions beanInstructions;

    /** The verified. */
    private boolean verified;

    /** The default converters. */
<span class="fc" id="L39">    private DefaultConverters defaultConverters = new DefaultConverters();</span>

    /**
     * Gets the bean property.
     *
     * @param currentColumn
     *            the current column
     *
     * @return the bean property
     */
    public abstract BeanProperty getBeanProperty(Column currentColumn);

    /**
     * Keys.
     *
     * @return the sets the
     */
    protected abstract Set&lt;Column&gt; keys();

    /**
     * Check key.
     *
     * @param header
     *            the header
     * @param key
     *            the key
     */
    protected abstract void checkKey(Header header, Column key);

    /**
     * Verify header.
     *
     * @param header
     *            the header
     */
    public void verifyHeader(Header header) {
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (verified) {</span>
<span class="fc" id="L76">            return;</span>
        }
<span class="fc bfc" id="L78" title="All 2 branches covered.">        for (Column key : keys()) {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (!getBeanProperty(key).isDynamicColumnProperty()) {</span>
<span class="fc" id="L80">                checkKey(header, key);</span>
            }
<span class="fc" id="L82">        }</span>
<span class="fc" id="L83">        verified = true;</span>
<span class="fc" id="L84">    }</span>

    /**
     * Gets the column.
     *
     * @param row
     *            the row
     *
     * @return the column
     */
    protected abstract Column getColumn(Row row);

    /**
     * Convert.
     *
     * @param bean
     *            the bean
     * @param row
     *            the row
     * @param lineNumber
     *            the line number
     * @param currentDynamicColumn
     *            the current dynamic column
     *
     * @return the t
     */
    public T convert(T bean, Row row, int lineNumber, DynamicColumn currentDynamicColumn) {
<span class="fc" id="L111">        BeanWrapper beanWrapper = new BeanWrapper(defaultConverters, bean);</span>

<span class="fc" id="L113">        Column currentColumn = null;</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        for (String cell : row) {</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            currentColumn = currentColumn == null ? getColumn(row) : currentColumn.nextColumn();</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (currentDynamicColumn.isDynamicColumnActive(currentColumn)) {</span>
<span class="fc" id="L118">                setDynamicColumnProperties(row, lineNumber, beanWrapper, currentColumn);</span>
<span class="fc" id="L119">                continue;</span>
            }

<span class="fc" id="L122">            BeanProperty beanProperty = getBeanProperty(currentColumn);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            if (beanProperty == null) {</span>
<span class="fc" id="L124">                continue;</span>
            }
<span class="pc bpc" id="L126" title="1 of 6 branches missed.">            if (beanProperty.isRequired() &amp;&amp; (cell == null || cell.equals(&quot;&quot;))) {</span>
<span class="fc" id="L127">                throw new CsvException(new RowError(</span>
<span class="fc" id="L128">                        &quot;Bean property \&quot;&quot; + beanProperty.getPropertyName()</span>
                                + &quot;\&quot; is required and may not be empty or null&quot;,
<span class="fc" id="L130">                        row.reportOnColumn(currentColumn.getColumnIndex()), lineNumber));</span>
            }
<span class="fc" id="L132">            setBeanProperty(row, lineNumber, beanWrapper, currentColumn, cell, beanProperty);</span>
<span class="fc" id="L133">        }</span>
<span class="fc" id="L134">        return bean;</span>
    }

    /**
     * Sets the dynamic column properties.
     *
     * @param row
     *            the row
     * @param lineNumber
     *            the line number
     * @param beanWrapper
     *            the bean wrapper
     * @param currentColumn
     *            the current column
     */
    private void setDynamicColumnProperties(Row row, int lineNumber, BeanWrapper beanWrapper, Column currentColumn) {
<span class="fc" id="L150">        BeanProperty headerNameProperty = beanInstructions.getProperties().getHeaderNameProperty();</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (headerNameProperty != null) {</span>
<span class="fc" id="L152">            String dynamicHeaderName = row.getHeader().getName(currentColumn.getColumnIndex());</span>
<span class="fc" id="L153">            setBeanProperty(row, lineNumber, beanWrapper, currentColumn, dynamicHeaderName, headerNameProperty);</span>
        }

<span class="fc" id="L156">        BeanProperty headerValueProperty = beanInstructions.getProperties().getHeaderValueProperty();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (headerValueProperty != null) {</span>
<span class="fc" id="L158">            String dynamicHeaderValue = row.get(currentColumn.getColumnIndex());</span>
<span class="fc" id="L159">            setBeanProperty(row, lineNumber, beanWrapper, currentColumn, dynamicHeaderValue, headerValueProperty);</span>
        }
<span class="fc" id="L161">    }</span>

    /**
     * Sets the bean property.
     *
     * @param row
     *            the row
     * @param lineNumber
     *            the line number
     * @param beanWrapper
     *            the bean wrapper
     * @param currentColumn
     *            the current column
     * @param cell
     *            the cell
     * @param beanProperty
     *            the bean property
     */
    private void setBeanProperty(Row row, int lineNumber, BeanWrapper beanWrapper, Column currentColumn, String cell,
            BeanProperty beanProperty) {
        try {
<span class="fc" id="L182">            beanWrapper.setProperty(beanProperty, cell);</span>
<span class="fc" id="L183">        } catch (ConversionException err) {</span>
<span class="fc" id="L184">            String message = err.getMessage() + &quot; cell&quot; + currentColumn.getColumnText() + &quot; [&quot; + cell + &quot;] to &quot;</span>
<span class="fc" id="L185">                    + beanProperty.getPropertyName() + &quot;: &quot; + err.getTypeDescription();</span>
<span class="fc" id="L186">            throw new CsvException(</span>
<span class="fc" id="L187">                    new RowError(message, row.reportOnColumn(currentColumn.getColumnIndex()), lineNumber));</span>
<span class="fc" id="L188">        }</span>
<span class="fc" id="L189">    }</span>

    /**
     * Sets the bean instructions.
     *
     * @param beanInstructions
     *            the new bean instructions
     */
    public void setBeanInstructions(BeanInstructions beanInstructions) {
<span class="fc" id="L198">        this.beanInstructions = beanInstructions;</span>
<span class="fc" id="L199">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>